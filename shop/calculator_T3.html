<!-- T3 Profitability Calculator -->
<section id="calculator" class="py-16 bg-slate-900">
    <div class="container mx-auto px-6">
        <div class="max-w-4xl mx-auto profitability-calculator rounded-xl p-8">
            <h2 class="text-3xl font-bold mb-8 text-center">Fluminer T3 Profitability Calculator</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <div class="mb-6">
                        <label for="coin-select" class="block text-sm font-medium mb-2">Select Coin</label>
                        <select id="coin-select" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="bitcoin" data-reward-rate="0.0000000001">Bitcoin (BTC)</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="electricity-cost" class="block text-sm font-medium mb-2">Electricity Cost ($/kWh)</label>
                        <input type="number" id="electricity-cost" value="0.0" step="0.01" min="0" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="calculate-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition duration-300">
                        Calculate Profitability
                    </button>
                </div>
                <div>
                    <div class="bg-slate-800 rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Estimated Results</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between">
                                <span class="text-slate-300">Daily Revenue:</span>
                                <span id="daily-revenue" class="font-medium">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-300">Daily Electricity Cost:</span>
                                <span id="daily-cost" class="font-medium">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-300">Daily Profit:</span>
                                <span id="daily-profit" class="font-medium">$0.00</span>
                            </div>
                            <div class="border-t border-slate-700 my-3"></div>
                            <div class="flex justify-between">
                                <span class="text-slate-300">Monthly Profit:</span>
                                <span id="monthly-profit" class="font-medium">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-300">ROI Period:</span>
                                <span id="roi-period" class="font-medium">0 months</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-sm text-slate-400">
                        <p>Note: These are estimates based on current market conditions. Actual results may vary significantly.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // Utility function for retrying API calls
    async function fetchWithRetry(url, retries = 3, delay = 1000) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                if (i < retries - 1) {
                    console.warn(`Retrying fetch for ${url} (${i + 1}/${retries})...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue;
                }
                throw error;
            }
        }
    }

    // Fetch current coin price
    async function fetchCoinPrice(coinId) {
        try {
            const data = await fetchWithRetry(`https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=usd`);
            const price = data[coinId]?.usd || 0;
            console.log(`Fetched ${coinId} Price:`, price);
            return price;
        } catch (error) {
            console.error(`Error fetching ${coinId} price:`, error.message);
            return 0;
        }
    }

    // Profitability calculator logic
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('calculate-btn').addEventListener('click', async function() {
            const coinSelect = document.getElementById('coin-select');
            const electricityCost = parseFloat(document.getElementById('electricity-cost').value);
            
            if (!coinSelect.value || isNaN(electricityCost) || electricityCost < 0) {
                alert('Please fill in all fields with valid non-negative values');
                return;
            }
            
            const coinId = coinSelect.value;
            const currentPrice = await fetchCoinPrice(coinId);
            if (currentPrice === 0) {
                alert('Unable to fetch Bitcoin price. Please try again later.');
                updateResults(0, 0, 2310);
                return;
            }
            
            // Fluminer T3 specifications
            const hashrate = 115000; // TH/s
            const powerUsage = 1700; // Watts
            const minerPrice = 2310; // Euros
            
            // Get reward rate from coin option
            const selectedCoin = coinSelect.options[coinSelect.selectedIndex];
            const rewardRate = parseFloat(selectedCoin.dataset.rewardRate || '0');
            console.log('Reward Rate:', rewardRate);
            
            const dailyReward = hashrate * rewardRate;
            console.log('Daily Reward (BTC):', dailyReward);
            
            const dailyRevenue = dailyReward * currentPrice;
            console.log('Daily Revenue:', dailyRevenue);
            
            const dailyCost = (powerUsage * 24 / 1000) * Math.max(0, electricityCost);
            console.log('Daily Cost:', dailyCost);
            
            updateResults(dailyRevenue, dailyCost, minerPrice);
        });

        function updateResults(dailyRevenue, dailyCost, minerPrice) {
            // Prevent negative values
            dailyRevenue = Math.max(0, dailyRevenue);
            dailyCost = Math.max(0, dailyCost);
            
            const dailyProfit = dailyRevenue - dailyCost;
            const monthlyProfit = dailyProfit * 30;
            
            // ROI calculation
            let roiPeriod = 'Not profitable';
            if (dailyProfit > 0) {
                roiPeriod = Math.ceil(minerPrice / (dailyProfit * 30)) + ' months';
            } else if (dailyProfit === 0) {
                roiPeriod = 'No profit (break-even)';
            }
            
            console.log('Results:', { dailyRevenue, dailyCost, dailyProfit, monthlyProfit, roiPeriod });
            
            document.getElementById('daily-revenue').textContent = '$' + dailyRevenue.toFixed(2);
            document.getElementById('daily-cost').textContent = '$' + dailyCost.toFixed(2);
            document.getElementById('daily-profit').textContent = '$' + dailyProfit.toFixed(2);
            document.getElementById('monthly-profit').textContent = '$' + monthlyProfit.toFixed(2);
            document.getElementById('roi-period').textContent = roiPeriod;
        }
    });
</script>
